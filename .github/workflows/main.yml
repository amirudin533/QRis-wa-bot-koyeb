name: ðŸ”§ Fix Bot Structure & Generate Lockfile

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ðŸ“¦ Ensure baileys-bot folder and clean package.json
        run: |
          mkdir -p baileys-bot
          
          # Pindahkan file dari root ke baileys-bot jika ada
          for f in package.json index.js .env.example; do
            if [ -f "$f" ] && [ ! -f "baileys-bot/$f" ]; then
              mv "$f" baileys-bot/
            fi
          done

          # Hapus package.json yang mungkin corrupt di baileys-bot
          rm -f baileys-bot/package.json
          
          # Buat package.json BARU yang valid
          cd baileys-bot
          cat > package.json <<'EOF'
{
  "name": "baileys-qris-bot",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "@whiskeysockets/baileys": "^6.7.0",
    "axios": "^1.6.0",
    "express": "^4.18.2",
    "qrcode-terminal": "^0.12.0"
  }
}
EOF
          
          # (Opsional) Tambahkan dependency proxy jika diperlukan
          npm install --package-lock-only
          cd ..

      - name: âœ… Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add baileys-bot/
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ”§ fix: regenerate valid package.json and package-lock.json"
            git push
          else
            echo "âœ… Tidak ada perubahan."
          fi
